<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Embedding Inversion with Qwen3-Embedding</title>
<style>
  :root {
    --bg: #08080d;
    --surface: #0e0e16;
    --border: rgba(255,255,255,0.07);
    --text: #d0d0d8;
    --text-dim: #5a5a6e;
    --accent: #7c6aef;
    --accent2: #a78bfa;
    --glow: rgba(124,106,239,0.55);
    --green: #34d399;
    --mask-bg: rgba(255,255,255,0.04);
    --mono: 'SF Mono','Fira Code','Cascadia Code','JetBrains Mono',monospace;
    --sans: 'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  }
  *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
  html { font-size:15px; }
  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  ::selection { background: var(--accent); color: #fff; }

  /* layout */
  .wrap { max-width:960px; margin:0 auto; padding:2.5rem 1.5rem 4rem; }

  /* header */
  header { margin-bottom:2.5rem; }
  h1 {
    font-size:2rem; font-weight:700; letter-spacing:-0.03em;
    background: linear-gradient(135deg,var(--accent),var(--accent2));
    -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    background-clip:text;
  }
  .tagline { color:var(--text-dim); margin-top:.35rem; font-size:.9rem; }

  /* cards */
  .card {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:12px;
    padding:1.4rem;
    margin-bottom:1.4rem;
  }
  .card-label {
    font-size:.7rem; font-weight:600; text-transform:uppercase;
    letter-spacing:.08em; color:var(--text-dim); margin-bottom:.75rem;
  }

  /* input row */
  .input-row { display:flex; gap:.6rem; }
  .input-row input {
    flex:1; background:rgba(255,255,255,0.04); border:1px solid var(--border);
    border-radius:8px; padding:.65rem .9rem; color:#fff;
    font-family:var(--mono); font-size:.9rem;
    transition: border-color .2s;
  }
  .input-row input:focus { outline:none; border-color:var(--accent); }
  .input-row input::placeholder { color:var(--text-dim); }

  /* buttons */
  .btn {
    border:none; border-radius:8px; padding:.65rem 1.2rem;
    font-size:.85rem; font-weight:600; cursor:pointer;
    transition: transform .15s, box-shadow .2s, opacity .2s;
    white-space: nowrap;
  }
  .btn:active { transform:scale(.97); }
  .btn-primary {
    background:linear-gradient(135deg,var(--accent),#9061f0);
    color:#fff; box-shadow:0 2px 12px rgba(124,106,239,.25);
  }
  .btn-primary:hover { box-shadow:0 4px 20px rgba(124,106,239,.4); }
  .btn-primary:disabled { opacity:.5; cursor:default; box-shadow:none; }
  .btn-ghost {
    background:rgba(255,255,255,0.06); color:var(--text);
  }
  .btn-ghost:hover { background:rgba(255,255,255,0.1); }

  /* embedding viz */
  .emb-row { display:flex; gap:1.2rem; align-items:stretch; flex-wrap:wrap; }
  .emb-canvas-wrap {
    flex:1; min-width:200px; height:52px;
    background:rgba(0,0,0,.25); border-radius:6px; overflow:hidden;
  }
  #embCanvas { width:100%; height:100%; display:block; }
  .emb-stats {
    display:flex; flex-direction:column; justify-content:center; gap:.25rem;
    min-width:140px;
  }
  .stat { font-size:.75rem; color:var(--text-dim); }
  .stat span { color:var(--accent2); font-family:var(--mono); font-weight:600; }

  /* progress */
  .progress-track {
    height:3px; background:rgba(255,255,255,0.06);
    border-radius:2px; overflow:hidden; margin-bottom:1rem;
  }
  .progress-fill {
    height:100%; width:0%;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    transition: width .12s linear;
  }

  /* token grid */
  .token-grid {
    display:flex; flex-wrap:wrap; gap:6px;
    min-height:48px; align-items:center;
    margin-bottom:1.2rem;
  }
  .token-grid .placeholder {
    color:var(--text-dim); font-size:.85rem; padding:1.5rem 0; width:100%; text-align:center;
  }
  .tok {
    display:inline-block;
    padding:.35rem .55rem;
    border-radius:5px;
    font-family:var(--mono);
    font-size:.82rem;
    line-height:1.3;
    border:1px solid transparent;
    transition: background .3s, color .3s, border-color .3s, box-shadow .3s, transform .2s;
  }
  .tok.masked {
    background:var(--mask-bg); color:var(--text-dim);
    border-color:rgba(255,255,255,0.05);
  }
  .tok.revealed {
    background:rgba(124,106,239,0.12); color:#e0d8ff;
    border-color:rgba(124,106,239,0.25);
  }
  .tok.changed {
    animation: pop .5s ease-out;
    background:rgba(124,106,239,0.3);
    color:#fff;
    border-color:var(--accent);
    box-shadow:0 0 14px var(--glow);
  }
  @keyframes pop {
    0%   { transform:scale(1.18); box-shadow:0 0 24px var(--glow); }
    100% { transform:scale(1);   box-shadow:0 0 14px var(--glow); }
  }

  /* decoded text */
  .decoded-box {
    background:rgba(0,0,0,.3); border:1px solid var(--border);
    border-radius:8px; padding:.85rem 1rem;
    font-family:var(--mono); font-size:.9rem; line-height:1.6;
    color: #c8c0f0;
    min-height:2.5rem;
    word-break: break-word;
  }

  /* metrics row */
  .metrics { display:flex; gap:1rem; margin-top:1rem; flex-wrap:wrap; }
  .metric-card {
    flex:1; min-width:140px;
    background:rgba(255,255,255,0.02);
    border:1px solid var(--border);
    border-radius:8px; padding:.85rem 1rem;
  }
  .metric-label {
    font-size:.65rem; text-transform:uppercase; letter-spacing:.07em;
    color:var(--text-dim); margin-bottom:.2rem;
  }
  .metric-value {
    font-size:1.3rem; font-weight:700; font-family:var(--mono);
    color:var(--accent2);
  }
  .metric-value.sim { color:var(--green); }
  .metric-value.small {
    font-size:.82rem; font-weight:400; color:var(--text);
    line-height:1.5; word-break:break-word;
  }

  /* step counter */
  .step-info {
    font-size:.75rem; color:var(--text-dim); font-family:var(--mono);
    margin-bottom:.6rem;
  }

  /* spinner */
  @keyframes spin { to { transform:rotate(360deg); } }
  .spinner {
    display:inline-block; width:14px; height:14px;
    border:2px solid rgba(255,255,255,.15);
    border-top-color:var(--accent);
    border-radius:50%; animation:spin .7s linear infinite;
    vertical-align:middle; margin-right:6px;
  }

  /* responsive */
  @media (max-width:600px) {
    .wrap { padding:1.5rem 1rem 3rem; }
    h1 { font-size:1.5rem; }
    .input-row { flex-direction:column; }
    .emb-row { flex-direction:column; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Embedding Inversion with Qwen3-Embedding</h1>
    <div class="tagline">Encode a sentence into a 1024-d vector using Qwen3-Embedding, then watch diffusion decode it back, token by token.</div>
  </header>

  <!-- Input -->
  <div class="card">
    <div class="card-label">Input</div>
    <div class="input-row">
      <input type="text" id="inp" placeholder="Type a sentence..." value="Stars shine brightest in the darkest nights" spellcheck="false">
      <button class="btn btn-ghost" onclick="doRandom()">Random</button>
      <button class="btn btn-primary" id="goBtn" onclick="run()">Invert &rarr;</button>
    </div>
  </div>

  <!-- Embedding -->
  <div class="card" id="embCard" style="display:none">
    <div class="card-label">Embedding vector <span style="opacity:.5">(1024-d)</span></div>
    <div class="emb-row">
      <div class="emb-canvas-wrap"><canvas id="embCanvas"></canvas></div>
      <div class="emb-stats">
        <div class="stat">min <span id="embMin">-</span></div>
        <div class="stat">max <span id="embMax">-</span></div>
        <div class="stat">norm <span id="embNorm">-</span></div>
      </div>
    </div>
  </div>

  <!-- Diffusion -->
  <div class="card" id="diffCard">
    <div class="card-label">Diffusion decoding</div>
    <div class="step-info" id="stepInfo"></div>
    <div class="progress-track"><div class="progress-fill" id="pbar"></div></div>
    <div class="token-grid" id="tgrid">
      <div class="placeholder">Press <strong>Invert</strong> to begin</div>
    </div>
    <div class="card-label" style="margin-top:.5rem">Reconstructed text</div>
    <div class="decoded-box" id="decoded">&mdash;</div>
    <div class="metrics" id="metricsRow" style="display:none">
      <div class="metric-card">
        <div class="metric-label">Cosine similarity</div>
        <div class="metric-value sim" id="mCos">&mdash;</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Original</div>
        <div class="metric-value small" id="mOrig">&mdash;</div>
      </div>
      <div class="metric-card">
        <div class="metric-label">Steps</div>
        <div class="metric-value" id="mSteps">&mdash;</div>
      </div>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);

let embedding = null;
let running = false;

async function doRandom() {
  const r = await fetch('/random');
  const d = await r.json();
  $('inp').value = d.text;
}

async function run() {
  if (running) return;
  const text = $('inp').value.trim();
  if (!text) return;
  running = true;
  $('goBtn').disabled = true;
  $('goBtn').innerHTML = '<span class="spinner"></span>Encoding...';
  $('metricsRow').style.display = 'none';
  $('decoded').textContent = '\u2014';
  $('stepInfo').textContent = '';
  $('pbar').style.width = '0%';
  $('tgrid').innerHTML = '<div class="placeholder"><span class="spinner"></span> Encoding input...</div>';

  try {
    // Encode
    const er = await fetch('/encode', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text})
    });
    const ed = await er.json();
    embedding = ed.embedding;
    showEmbedding(embedding);
    $('mOrig').textContent = text;

    // Decode (SSE)
    $('goBtn').innerHTML = '<span class="spinner"></span>Decoding...';
    initMaskGrid();

    const dr = await fetch('/decode', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({embedding, steps: 32})
    });

    const reader = dr.body.getReader();
    const dec = new TextDecoder();
    let buf = '';

    while (true) {
      const {done, value} = await reader.read();
      if (done) break;
      buf += dec.decode(value, {stream:true});
      const lines = buf.split('\n');
      buf = lines.pop();
      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const evt = JSON.parse(line.slice(6));
          handleStep(evt);
        }
      }
    }
  } catch(e) {
    console.error(e);
    $('decoded').textContent = 'Error: ' + e.message;
  }
  running = false;
  $('goBtn').disabled = false;
  $('goBtn').innerHTML = 'Invert &rarr;';
}

function showEmbedding(emb) {
  $('embCard').style.display = '';
  const canvas = $('embCanvas');
  const rect = canvas.parentElement.getBoundingClientRect();
  canvas.width = rect.width * 2;
  canvas.height = rect.height * 2;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  let mn = Infinity, mx = -Infinity, s2 = 0;
  for (const v of emb) { mn=Math.min(mn,v); mx=Math.max(mx,v); s2+=v*v; }
  $('embMin').textContent = mn.toFixed(3);
  $('embMax').textContent = mx.toFixed(3);
  $('embNorm').textContent = Math.sqrt(s2).toFixed(3);

  const w = canvas.width, h = canvas.height;
  const barW = w / emb.length;
  for (let i=0; i<emb.length; i++) {
    const t = (emb[i] - mn) / (mx - mn + 1e-9);
    // purple-cyan gradient
    const r = Math.round(60 + t*100);
    const g = Math.round(40 + t*160);
    const b = Math.round(180 + t*60);
    ctx.fillStyle = `rgb(${r},${g},${b})`;
    ctx.fillRect(i*barW, 0, Math.ceil(barW), h);
  }
}

function initMaskGrid() {
  const grid = $('tgrid');
  grid.innerHTML = '';
  for (let i=0; i<32; i++) {
    const el = document.createElement('span');
    el.className = 'tok masked';
    el.textContent = '[MASK]';
    el.id = 'tk'+i;
    grid.appendChild(el);
  }
}

function handleStep(evt) {
  // progress
  $('pbar').style.width = (evt.progress * 100) + '%';
  $('stepInfo').textContent = `step ${evt.step+1} / ${evt.total}`;

  // tokens
  const tokens = evt.tokens;
  for (let i=0; i<tokens.length; i++) {
    const el = $('tk'+i);
    if (!el) continue;
    const tk = tokens[i];
    el.textContent = tk.t;
    if (tk.s === 'm') {
      el.className = 'tok masked';
    } else if (tk.s === 'c') {
      el.className = 'tok changed';
    } else {
      el.className = 'tok revealed';
    }
  }

  // decoded text
  $('decoded').textContent = evt.text || '\u2014';

  // final
  if (evt.done) {
    $('metricsRow').style.display = 'flex';
    const sim = evt.cosine_similarity;
    $('mCos').textContent = (sim * 100).toFixed(1) + '%';
    $('mSteps').textContent = evt.step;
    $('stepInfo').textContent = 'done';
  }
}

// Enter key triggers run
$('inp').addEventListener('keydown', e => { if (e.key === 'Enter') run(); });
</script>
</body>
</html>
